# this file is entirly generated by makefile
ARG base_image_ubuntu2004=ubuntu:20.04
ARG base_image_ubuntu2204=ubuntu:22.04
ARG base_image_centos8=quay.io/centos/centos:stream8
ARG base_image_centos9=quay.io/centos/centos:stream9

FROM --platform=${BUILDPLATFORM} ${base_image_ubuntu2004} as ubuntu2004_builder
ADD install-tools.sh .
RUN chmod +x install-tools.sh && ./install-tools.sh

FROM --platform=${BUILDPLATFORM} ${base_image_ubuntu2204} as ubuntu2204_builder
ADD install-tools.sh .
RUN chmod +x install-tools.sh && ./install-tools.sh

FROM --platform=${BUILDPLATFORM} ${base_image_centos8} as centos8_builder
ADD install-tools.sh .
RUN chmod +x install-tools.sh && ./install-tools.sh

FROM --platform=${BUILDPLATFORM} ${base_image_centos9} as centos9_builder
ADD install-tools.sh .
RUN chmod +x install-tools.sh && ./install-tools.sh

FROM alpine:3
RUN mkdir -p /host/ubuntu2004/usr/bin && mkdir -p /host/ubuntu2004/usr/lib
COPY --from=ubuntu2004_builder /host/ubuntu2004/usr/bin /host/ubuntu2004/usr/bin
COPY --from=ubuntu2004_builder /host/ubuntu2004/usr/lib/libsmc-preload.so /host/ubuntu2004/usr/lib

RUN mkdir -p /host/ubuntu2204/usr/bin && mkdir -p /host/ubuntu2204/usr/lib
COPY --from=ubuntu2204_builder /host/ubuntu2204/usr/bin /host/ubuntu2204/usr/bin
COPY --from=ubuntu2204_builder /host/ubuntu2204/usr/lib/libsmc-preload.so /host/ubuntu2204/usr/lib

RUN mkdir -p /host/centos8/usr/bin && mkdir -p /host/centos8/usr/lib
COPY --from=centos8_builder /host/centos8/usr/bin /host/centos8/usr/bin
COPY --from=centos8_builder /host/centos8/usr/lib/libsmc-preload.so /host/centos8/usr/lib

RUN mkdir -p /host/centos9/usr/bin && mkdir -p /host/centos9/usr/lib
COPY --from=centos9_builder /host/centos9/usr/bin /host/centos9/usr/bin
COPY --from=centos9_builder /host/centos9/usr/lib/libsmc-preload.so /host/centos9/usr/lib

WORKDIR /host/
ADD modules /host/modules
ADD entrypoint.sh /host/
ADD smc-os-list.json /host/
RUN chmod +x /host/entrypoint.sh

ENTRYPOINT ["sh","entrypoint.sh"]
